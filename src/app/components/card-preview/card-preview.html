<div class="preview-wrapper">
  @if (isLoading()) {
    <div class="loading-screen">
      <div class="spinner-large"></div>
      <p>Carregando seu convite...</p>
    </div>
  } @else if (card(); as cardData) {
    <div class="invite-card"
         [class.has-photo]="cardData.photoUrl"
         [style.font-family]="themeFont() + ', sans-serif'"
         [style.background-color]="themeBgColor()"
         [style.color]="schemeText()"
         [style.background-image]="cardData.photoUrl ? 'url(' + cardData.photoUrl + ')' : 'none'">

      @if (authService.isAuthenticated()) {
        <button class="back-btn" (click)="goBack()">
          {{ isLiveInvite() ? '‚Üê Voltar ao painel' : '‚Üê Voltar ao editor' }}
        </button>
      }

      @if (cardData.floatingEmoji) {
        <div class="floating-emojis" aria-hidden="true">
          @for (p of floatingParticles; track p.id) {
            <span
              class="floating-emoji"
              [style.left]="p.left"
              [style.animation-delay]="p.delay"
              [style.animation-duration]="p.duration"
              [style.font-size]="p.size">{{ cardData.floatingEmoji }}</span>
          }
        </div>
      }

      <div class="card-content">
        <h1 class="card-title" [style.color]="schemePrimary()">{{ cardData.title }}</h1>

        @if (!tokenValid()) {
          <div class="error-message" [style.background-color]="schemePrimary() + '20'" [style.color]="schemePrimary()">
            <strong>‚ö†Ô∏è {{ errorMessage() || 'Este convite n√£o pode mais receber confirma√ß√µes' }}</strong>
            <p>O convite j√° foi confirmado ou expirou.</p>
          </div>
        }

        <p class="card-message">{{ cardData.message }}</p>

        <p class="card-sender">
          Com carinho, <strong [style.color]="schemePrimary()">{{ cardData.senderName || 'Anfitri√£o' }}</strong>
        </p>

        @if (cardData.musicUrl) {
          <div class="card-music">
            <div class="music-player">
              <button class="btn-mute" (click)="toggleMute()" title="Mutar/Desmutar">
                {{ isMuted() ? 'üîá' : 'üîä' }}
              </button>
              <audio #audioPlayer [src]="cardData.musicUrl" (play)="onAudioPlay()" (pause)="onAudioPause()"></audio>
            </div>
          </div>
        }

        <div class="rsvp-section">
          <p class="rsvp-title" [style.color]="schemePrimary()">Voc√™ confirma presen√ßa?</p>

          <app-no-button-mechanics
            [mechanic]="cardData.noButtonMechanic"
            [disabled]="!tokenValid()"
            (responded)="onResponse($event)" />
        </div>
      </div>

      @if (cardData.id && !isLiveInvite()) {
        <div class="share-bar">
          <h3 class="share-title">üì§ Compartilhar Convite</h3>

          <div class="share-buttons">
            <button class="btn btn-whatsapp" (click)="shareWhatsApp()">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
              </svg>
              Enviar via WhatsApp
            </button>
            <button class="btn btn-secondary" (click)="copyLink()">
              {{ linkCopied() ? '‚úÖ Link Copiado!' : 'üìé Copiar Link' }}
            </button>
          </div>

          <div class="whatsapp-direct">
            <button class="toggle-direct" (click)="showWhatsappInput.set(!showWhatsappInput())">
              üì± Enviar para n√∫mero espec√≠fico
              <span class="toggle-arrow">{{ showWhatsappInput() ? '‚ñ≤' : '‚ñº' }}</span>
            </button>

            @if (showWhatsappInput()) {
              <div class="direct-form">
                <div class="phone-input-group">
                  <span class="phone-prefix">+55</span>
                  <input
                    type="tel"
                    placeholder="11999998888"
                    [ngModel]="whatsappPhone()"
                    (ngModelChange)="whatsappPhone.set($event)" />
                </div>
                <button
                  class="btn btn-whatsapp btn-sm"
                  [disabled]="!whatsappPhone()"
                  (click)="shareWhatsAppDirect()">
                  Enviar ‚Üí
                </button>
              </div>
            }
          </div>
        </div>
      }
    </div>
  } @else {
    <div class="no-card">
      <h2>Nenhum convite encontrado</h2>
      <p>Crie um novo convite para visualizar!</p>
      <button class="btn btn-primary" (click)="goBack()">Criar Convite</button>
    </div>
  }
</div>
